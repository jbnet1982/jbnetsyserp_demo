<div class="container-fluid min-vh-100 bg-light">
  
  <!-- CABECERA SUPERIOR -->
  <div class="row py-3 border-bottom bg-white mb-4 shadow-sm align-items-center">
    <div class="col-auto">
      <button cButton color="light" routerLink="/" class="border" cTooltip="Volver al Menú Principal">
        <c-icon [content]="icons.cilArrowLeft"></c-icon>
      </button>
    </div>
    <div class="col">
      <h4 class="mb-0 text-primary fw-bold">Módulo Contabilidad General</h4>
      <small class="text-secondary text-uppercase ls-1">JBNetsys ERP Edition</small>
    </div>
    <div class="col-auto">
      <span class="badge bg-primary px-3 py-2 rounded-pill">Periodo: Nov 2025</span>
    </div>
  </div>

  <div class="row g-4 px-3 pb-5">
    
    <!-- MENÚ NAVEGACIÓN (IZQUIERDA) -->
    <div class="col-md-3 col-xl-2 fade-in-left">
      <c-card class="border-0 shadow-sm h-100">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="mb-0 fw-bold"><c-icon [content]="icons.cilFolderOpen" class="me-2"></c-icon> Navegación</h6>
        </div>
        <div class="card-body p-0">
          <c-accordion [alwaysOpen]="false" class="accordion-flush">
            <c-accordion-item *ngFor="let grupo of menuEstructura; let i = index" [visible]="i === 0">
              <ng-template cTemplateId="accordionHeader">
                 <div class="fw-semibold small text-uppercase d-flex align-items-center gap-2">
                    <c-icon [content]="grupo.icono === 'cilBook' ? icons.cilBook : (grupo.icono === 'cilMoney' ? icons.cilMoney : (grupo.icono === 'cilLockLocked' ? icons.cilLockLocked : icons.cilChartLine))" class="text-primary"></c-icon>
                    {{ grupo.titulo }}
                 </div>
              </ng-template>
              <ng-template cTemplateId="accordionBody">
                <div class="list-group list-group-flush">
                  <button *ngFor="let sub of grupo.items" 
                    class="list-group-item list-group-item-action border-0 ps-3 small py-2"
                    [class.active]="vistaActual === sub.id"
                    [class.fw-bold]="vistaActual === sub.id"
                    (click)="seleccionarVista(sub)">
                    • {{ sub.nombre }}
                  </button>
                </div>
              </ng-template>
            </c-accordion-item>
          </c-accordion>
        </div>
        <div class="p-3 border-top mt-auto">
             <button class="btn btn-outline-secondary w-100 btn-sm" (click)="volverDashboard()">
               <c-icon [content]="icons.cilChartLine"></c-icon> Ir al Resumen
             </button>
        </div>
      </c-card>
    </div>

    <!-- ÁREA DE CONTENIDO (DERECHA) -->
    <div class="col-md-9 col-xl-10">
      <div class="card border-0 shadow-sm min-vh-75">
        
        <!-- HEADER DINÁMICO DE LA VISTA -->
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="fw-bold text-dark-emphasis mb-0">{{ tituloVista }}</h5>
            
            <div class="d-flex gap-2">
                <!-- Barra herramientas Reportes -->
                <div *ngIf="vistaActual.includes('libro') || vistaActual.includes('balance') || vistaActual.includes('estado') || vistaActual.includes('movimientos')" class="btn-group me-2">
                    <button cButton color="light" class="border"><c-icon [content]="icons.cilPrint"></c-icon></button>
                    <button cButton color="light" class="border"><c-icon [content]="icons.cilSearch"></c-icon></button>
                </div>

                <button cButton color="secondary" variant="ghost" class="border" (click)="exportarPDF()">
                   <c-icon [content]="icons.cilCloudDownload"></c-icon> PDF
                </button>
                
                <!-- BOTONES DE ACCIÓN SEGÚN VISTA -->
                <button *ngIf="vistaActual === 'asientos-manuales'" cButton color="primary" (click)="toggleModal()"><c-icon [content]="icons.cilPlus"></c-icon> Nuevo</button>
                <button *ngIf="vistaActual === 'plan-cuentas'" cButton color="primary" (click)="toggleModalCuenta()"><c-icon [content]="icons.cilPlus"></c-icon> Cuenta</button>
                <button *ngIf="vistaActual === 'tipos-cuentas'" cButton color="primary" (click)="toggleModalTipoCuenta()"><c-icon [content]="icons.cilPlus"></c-icon> Tipo</button>
                <button *ngIf="vistaActual === 'centros-costo'" cButton color="primary" (click)="toggleModalCentroCosto()"><c-icon [content]="icons.cilPlus"></c-icon> Centro</button>
                <button *ngIf="vistaActual === 'sucursales'" cButton color="primary" (click)="toggleModalSucursal()"><c-icon [content]="icons.cilPlus"></c-icon> Sucursal</button>
                <button *ngIf="vistaActual === 'monedas'" cButton color="primary" (click)="toggleModalMoneda()"><c-icon [content]="icons.cilPlus"></c-icon> Moneda</button>
                <button *ngIf="vistaActual === 'asientos-recurrentes'" cButton color="primary" (click)="toggleModalRecurrente()"><c-icon [content]="icons.cilLoop" class="me-1"></c-icon> Nueva</button>
                <button *ngIf="vistaActual === 'importacion'" cButton color="primary" (click)="toggleModalImportacion()"><c-icon [content]="icons.cilCloudUpload" class="me-1"></c-icon> Importar</button>
                <button *ngIf="vistaActual === 'plantillas'" cButton color="primary" (click)="toggleModalPlantilla()"><c-icon [content]="icons.cilPlus"></c-icon> Plantilla</button>
                
                <button *ngIf="vistaActual === 'cierre-mensual'" cButton color="primary" (click)="toggleModalCierre('Cierre Mensual')"><c-icon [content]="icons.cilLockLocked" class="me-1"></c-icon> Ejecutar Cierre</button>
                <button *ngIf="vistaActual === 'reapertura'" cButton color="danger" variant="outline" (click)="toggleModalCierre('Reapertura')"><c-icon [content]="icons.cilLockUnlocked" class="me-1"></c-icon> Reapertura</button>
            </div>
        </div>

        <div class="card-body bg-light-subtle">
            
            <!-- 1. DASHBOARD (CORREGIDO: SE AGREGÓ LA COLUMNA PATRIMONIO) -->
            <ng-container *ngIf="vistaActual === 'dashboard'">
                <div class="row g-4 fade-in-up">
                    <div class="col-md-4">
                        <c-card class="border-0 shadow-sm border-top border-4 border-success p-4 text-center">
                          <h2 class="display-6 fw-bold">{{ totalActivos | currency }}</h2>
                          <small class="text-uppercase fw-bold text-muted">Activos</small>
                        </c-card>
                    </div>
                    <div class="col-md-4">
                        <c-card class="border-0 shadow-sm border-top border-4 border-danger p-4 text-center">
                          <h2 class="display-6 fw-bold">{{ totalPasivos | currency }}</h2>
                          <small class="text-uppercase fw-bold text-muted">Pasivos</small>
                        </c-card>
                    </div>
                    <!-- AQUI ESTA LA COLUMNA FALTANTE: -->
                    <div class="col-md-4">
                        <c-card class="border-0 shadow-sm border-top border-4 border-info p-4 text-center">
                          <h2 class="display-6 fw-bold">{{ patrimonioNeto | currency }}</h2>
                          <small class="text-uppercase fw-bold text-muted">Patrimonio</small>
                        </c-card>
                    </div>
                    
                    <div class="col-12 mt-5 text-center text-muted">
                        <c-icon [content]="icons.cilSpreadsheet" size="4xl" class="mb-3 opacity-25"></c-icon>
                        <h4>Bienvenido al Área Contable</h4>
                        <p>Seleccione un módulo del menú lateral para comenzar.</p>
                    </div>
                </div>
            </ng-container>

            <!-- 2. ASIENTOS MANUALES -->
            <ng-container *ngIf="vistaActual === 'asientos-manuales'">
                 <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                        <thead class="bg-light text-uppercase small text-secondary">
                            <tr>
                                <th class="ps-3">Fecha / Código</th>
                                <th>Descripción</th>
                                <th>Cuenta</th>
                                <th class="text-end">Débito</th>
                                <th class="text-end">Crédito</th>
                                <th class="text-center">Estado</th>
                                <th class="text-end pe-3">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of listaVisible">
                                <td class="ps-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light border rounded px-2 py-1 text-center me-3 d-none d-md-block" style="min-width: 50px;">
                                            <div class="small text-muted text-uppercase" style="font-size: 0.65rem;">Nov</div>
                                            <div class="fw-bold text-dark lh-1">{{ item.fecha.substring(0,2) }}</div>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">{{ item.fecha }}</div>
                                            <div class="small text-muted font-monospace">{{ item.codigo }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center text-dark-emphasis">
                                        <c-icon [content]="icons.cilSpreadsheet" class="me-2 text-primary"></c-icon>
                                        <span class="fw-bold">{{ item.desc }}</span>
                                    </div>
                                </td>
                                <td><span class="badge bg-light text-dark border fw-normal"><c-icon [content]="icons.cilFolderOpen" size="sm" class="me-1 text-secondary"></c-icon> {{ item.cuenta }}</span></td>
                                <td class="text-end"><span class="fw-semibold text-success">{{ item.debito > 0 ? (item.debito | currency) : '-' }}</span></td>
                                <td class="text-end"><span class="fw-semibold text-danger">{{ item.credito > 0 ? (item.credito | currency) : '-' }}</span></td>
                                <td class="text-center"><c-badge [color]="item.estado === 'Posteado' ? 'success' : 'warning'" shape="rounded-pill">{{ item.estado }}</c-badge></td>
                                <td class="text-end pe-3"><button cButton color="transparent" size="sm"><c-icon [content]="icons.cilPencil" class="text-primary"></c-icon></button></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-3 text-center" *ngIf="asientos.length > 5">
                        <button class="btn btn-link text-decoration-none small fw-bold" (click)="toggleShowAll()">{{ showAll ? 'Ver menos' : 'Ver todo' }}</button>
                    </div>
                 </div>
            </ng-container>

            <!-- 3. PLAN DE CUENTAS -->
            <ng-container *ngIf="vistaActual === 'plan-cuentas'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover small class="mb-0 align-middle table-sm">
                        <thead class="bg-light text-uppercase small text-secondary">
                            <tr>
                                <th class="ps-3">Código</th>
                                <th>Nombre de la Cuenta</th>
                                <th class="text-center">Tipo</th>
                                <th class="text-center">Nivel</th>
                                <th class="text-end pe-3">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let c of planCuentas" [class.bg-light]="c.nivel === 1">
                                <td class="ps-3 fw-bold text-dark-emphasis">{{ c.codigo }}</td>
                                <td>
                                    <div class="d-flex align-items-center" [style.padding-left.px]="(c.nivel - 1) * 20">
                                        <c-icon [content]="c.tipo === 'Detalle' ? icons.cilSpreadsheet : icons.cilFolderOpen" 
                                                class="me-2" 
                                                [ngClass]="c.tipo === 'Detalle' ? 'text-success' : 'text-warning'">
                                        </c-icon>
                                        <span [class.fw-bold]="c.nivel < 3" [class.text-dark]="c.nivel < 3">{{ c.nombre }}</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <c-badge [color]="c.tipo === 'Grupo' ? 'primary' : (c.tipo === 'SubGrupo' ? 'info' : 'light text-dark border')" shape="rounded-pill">
                                        {{ c.tipo }}
                                    </c-badge>
                                </td>
                                <td class="text-center text-muted font-monospace">{{ c.nivel }}</td>
                                <td class="text-end pe-3">
                                    <button cButton color="transparent" size="sm"><c-icon [content]="icons.cilPencil" class="text-primary"></c-icon></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 4. TIPOS DE CUENTAS -->
            <ng-container *ngIf="vistaActual === 'tipos-cuentas'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                        <thead class="bg-light text-uppercase small text-secondary">
                            <tr>
                                <th class="ps-3">Código ID</th>
                                <th>Clasificación</th>
                                <th>Naturaleza Saldo</th>
                                <th>Notas / Descripción</th>
                                <th class="text-end pe-3">Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let t of tiposCuentas">
                                <td class="ps-3">
                                    <div class="border rounded bg-light d-inline-block px-2 py-1 fw-bold text-primary">{{ t.codigo }}</div>
                                </td>
                                <td class="fw-bold text-dark">{{ t.nombre }}</td>
                                <td>
                                    <c-badge [color]="t.naturaleza.includes('Deudora') ? 'info' : 'warning'" class="text-white" shape="rounded-pill">
                                        {{ t.naturaleza }}
                                    </c-badge>
                                </td>
                                <td class="text-muted small">{{ t.descripcion }}</td>
                                <td class="text-end pe-3">
                                    <c-badge color="success" shape="rounded-pill">Activo</c-badge>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 5. CENTROS DE COSTO -->
            <ng-container *ngIf="vistaActual === 'centros-costo'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover responsive class="mb-0 align-middle">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr>
                             <th class="ps-3">Código</th>
                             <th>Centro de Costo</th>
                             <th>Categoría</th>
                             <th>Responsable</th>
                             <th class="text-end">Presupuesto</th>
                             <th class="text-center pe-3">Estado</th>
                          </tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let c of centrosCosto">
                             <td class="ps-3 fw-bold text-primary">{{ c.codigo }}</td>
                             <td><span class="fw-bold d-block text-dark">{{ c.nombre }}</span></td>
                             <td><c-badge color="info" class="text-white" shape="rounded-pill">{{ c.categoria }}</c-badge></td>
                             <td>
                                 <div class="d-flex align-items-center">
                                     <div class="avatar bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2 small" style="width:24px; height:24px;">{{ c.responsable.charAt(0) }}</div>
                                     <span class="small fw-semibold">{{ c.responsable }}</span>
                                 </div>
                             </td>
                             <td class="text-end fw-bold text-dark-emphasis">{{ c.presupuesto | currency }}</td>
                             <td class="text-center pe-3">
                                 <c-badge color="success" shape="rounded-pill">Activo</c-badge>
                             </td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>
            
            <!-- 6. SUCURSALES -->
            <ng-container *ngIf="vistaActual === 'sucursales'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover responsive class="mb-0 align-middle">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr>
                             <th class="ps-3">Código</th>
                             <th>Sucursal</th>
                             <th>Ubicación</th>
                             <th>Contacto</th>
                             <th>Responsable</th>
                             <th class="text-center pe-3">Estado</th>
                          </tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let s of sucursales">
                             <td class="ps-3 fw-bold text-primary">{{ s.codigo }}</td>
                             <td>
                                 <div class="d-flex align-items-center">
                                     <c-icon [content]="icons.cilBuilding" class="me-2 text-secondary"></c-icon>
                                     <span class="fw-bold text-dark">{{ s.nombre }}</span>
                                 </div>
                             </td>
                             <td>
                                 <small class="d-block fw-bold text-dark"><c-icon [content]="icons.cilLocationPin" size="sm"></c-icon> {{ s.ciudad }}</small>
                                 <small class="text-muted d-block text-truncate" style="max-width:180px">{{ s.direccion }}</small>
                             </td>
                             <td class="small">{{ s.telefono }}</td>
                             <td class="small fw-semibold">{{ s.responsable }}</td>
                             <td class="text-center pe-3">
                                <c-badge [color]="s.estado === 'Activo' ? 'success' : 'warning'" shape="rounded-pill">
                                    {{ s.estado }}
                                </c-badge>
                                <button cButton color="transparent" size="sm" class="ms-1">
                                    <c-icon [content]="icons.cilPencil" class="text-secondary"></c-icon>
                                </button>
                             </td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 7. MONEDAS -->
            <ng-container *ngIf="vistaActual === 'monedas'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr>
                             <th class="ps-3">ISO Código</th>
                             <th>Nombre Moneda</th>
                             <th>Tasa Cambio</th>
                             <th class="text-center">Moneda Base</th>
                             <th class="text-center pe-3">Estado</th>
                          </tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let m of monedas" [class.bg-light-subtle]="m.esBase">
                             <td class="ps-3">
                                 <div class="d-flex align-items-center">
                                     <div class="border rounded bg-white px-2 py-0 me-2 fw-bold text-dark small shadow-sm">{{ m.simbolo }}</div>
                                     <span class="fw-bold text-primary">{{ m.codigo }}</span>
                                 </div>
                             </td>
                             <td class="fw-bold text-dark">{{ m.nombre }}</td>
                             <td class="font-monospace text-dark">
                                 {{ m.tasa | number:'1.4-4' }}
                             </td>
                             <td class="text-center">
                                 <c-badge *ngIf="m.esBase" color="success" shape="rounded-pill">BASE FUNCIONAL</c-badge>
                                 <span *ngIf="!m.esBase" class="text-muted small">-</span>
                             </td>
                             <td class="text-center pe-3"><c-badge color="success" shape="rounded-pill">{{ m.estado }}</c-badge></td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 8. ASIENTOS RECURRENTES -->
            <ng-container *ngIf="vistaActual === 'asientos-recurrentes'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr>
                             <th class="ps-3">Plantilla / Descripción</th>
                             <th>Frecuencia</th>
                             <th class="text-center">Próxima Ejecución</th>
                             <th class="text-end">Monto Estimado</th>
                             <th class="text-center">Estado</th>
                             <th class="text-end pe-3">Acciones</th>
                          </tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let r of asientosRecurrentes">
                             <td class="ps-3 fw-bold">
                                 <div class="d-flex align-items-center text-primary">
                                    <c-icon [content]="icons.cilLoop" class="me-2 text-info"></c-icon>
                                    {{ r.nombre }}
                                 </div>
                             </td>
                             <td><c-badge color="info" shape="rounded-pill" class="text-white">{{ r.frecuencia }}</c-badge></td>
                             <td class="text-center">
                                 <div class="small fw-bold">{{ r.proximaFecha }}</div>
                                 <div class="text-muted" style="font-size: 0.75rem;">(Día {{ r.diaEjecucion }})</div>
                             </td>
                             <td class="text-end fw-semibold">{{ r.monto | currency }}</td>
                             <td class="text-center"><c-badge color="success">{{ r.estado }}</c-badge></td>
                             <td class="text-end pe-3">
                                 <button cButton color="transparent" size="sm">
                                     <c-icon [content]="icons.cilArrowLeft" style="transform: rotate(180deg);" class="text-success"></c-icon>
                                 </button>
                             </td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 9. IMPORTACIÓN -->
            <ng-container *ngIf="vistaActual === 'importacion'">
                <div class="fade-in-up">
                    <div class="bg-white rounded p-4 mb-4 text-center border-dashed" style="border:2px dashed #ccc">
                        <c-icon [content]="icons.cilCloudUpload" size="4xl" class="opacity-25"></c-icon>
                        <h5>Zona Carga</h5>
                        <button cButton color="primary" variant="outline" (click)="toggleModalImportacion()">Subir Archivo</button>
                    </div>
                    <div class="bg-white rounded p-3 shadow-sm">
                        <table cTable hover class="mb-0 align-middle">
                            <thead class="bg-light text-uppercase small text-secondary">
                                <tr>
                                    <th class="ps-3">Fecha</th>
                                    <th>Archivo</th>
                                    <th>Regs</th>
                                    <th class="text-end pe-3">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let i of historialImportaciones">
                                    <td class="ps-3 fw-bold">{{ i.fecha }}</td>
                                    <td>{{ i.archivo }}</td>
                                    <td>{{ i.registros }}</td>
                                    <td class="text-end pe-3"><c-badge color="success">{{ i.estado }}</c-badge></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </ng-container>

            <!-- 10. PLANTILLAS -->
            <ng-container *ngIf="vistaActual === 'plantillas'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr>
                             <th class="ps-3">Código</th>
                             <th>Nombre</th>
                             <th>Categoría</th>
                             <th class="text-center">Items</th>
                             <th class="text-end pe-3">Estado</th>
                          </tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let p of plantillasAsientos">
                             <td class="ps-3 fw-bold">{{ p.codigo }}</td>
                             <td>{{ p.nombre }}</td>
                             <td>{{ p.categoria }}</td>
                             <td class="text-center">{{ p.items }}</td>
                             <td class="text-end pe-3">Activo</td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 11. CIERRE MENSUAL -->
            <ng-container *ngIf="vistaActual === 'cierre-mensual'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <div class="alert alert-info d-flex align-items-center mb-3">
                        <c-icon [content]="icons.cilTask" class="me-2"></c-icon>
                        <strong>Checklist Pre-Cierre Nov 2025</strong>
                    </div>
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-secondary small">
                          <tr>
                             <th class="ps-3">Tarea</th>
                             <th class="text-center">Req</th>
                             <th class="text-center">Estado</th>
                             <th class="text-end pe-3">Acción</th>
                          </tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let v of validacionCierre">
                             <td class="ps-3 fw-bold">{{v.tarea}}</td>
                             <td class="text-center">{{v.requerido?'SI':'NO'}}</td>
                             <td class="text-center"><c-badge [color]="v.estado==='Completado'?'success':'warning'">{{v.estado}}</c-badge></td>
                             <td class="text-end pe-3"><button cButton size="sm" color="light">Ver</button></td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 12. CIERRE ANUAL -->
            <ng-container *ngIf="vistaActual === 'cierre-anual'">
                <div class="fade-in-up text-center pt-5">
                    <div class="d-inline-block p-4 rounded-circle bg-warning-subtle mb-3">
                        <c-icon [content]="icons.cilCalendar" size="4xl" class="text-warning"></c-icon>
                    </div>
                    <h4>Cierre Fiscal</h4>
                    <p class="text-muted">Generación automática de asientos de cierre y traslado a resultados.</p>
                    <button cButton color="warning" class="text-white mt-3 px-4 fw-bold" (click)="toggleModalCierre('Cierre Fiscal 2025')">
                        Procesar 2025
                    </button>
                </div>
            </ng-container>

            <!-- 13. REAPERTURA -->
            <ng-container *ngIf="vistaActual === 'reapertura'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-secondary small">
                          <tr><th class="ps-3">Periodo</th><th>Usuario</th><th>Motivo</th><th class="text-end pe-3">Estado</th></tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let r of reaperturas">
                             <td class="ps-3 fw-bold">{{r.periodo}}</td>
                             <td>{{r.usuario}}</td>
                             <td>{{r.motivo}}</td>
                             <td class="text-end pe-3"><c-badge color="success">{{r.estado}}</c-badge></td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 14. ESTADOS PERIODO -->
            <ng-container *ngIf="vistaActual === 'estados-periodo'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-secondary small">
                          <tr><th class="ps-3">Mes</th><th class="text-center">Estado</th><th class="text-center">Cierre</th><th class="text-end pe-3">Acc</th></tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let p of periodosContables">
                             <td class="ps-3 fw-bold">{{p.mes}}</td>
                             <td class="text-center"><c-badge [color]="p.estado==='Abierto'?'success':'dark'">{{p.estado}}</c-badge></td>
                             <td class="text-center">{{p.cierre}}</td>
                             <td class="text-end pe-3"><c-icon [content]="icons.cilLockUnlocked"></c-icon></td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 15. REPORTES: LIBRO DIARIO -->
            <ng-container *ngIf="vistaActual === 'libro-diario'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle table-striped table-sm">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr><th class="ps-3">Fecha/Asiento</th><th>Cta</th><th>Desc</th><th class="text-end">Debe</th><th class="text-end pe-3">Haber</th></tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let r of reporteDiario">
                             <td class="ps-3 fw-bold">{{r.fecha}} <span class="small fw-normal">{{r.codigo}}</span></td>
                             <td>{{r.cuenta}}</td>
                             <td>{{r.desc}}</td>
                             <td class="text-end fw-bold">{{r.debe>0?(r.debe|currency):'-'}}</td>
                             <td class="text-end pe-3 fw-bold">{{r.haber>0?(r.haber|currency):'-'}}</td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 16. REPORTES: LIBRO MAYOR -->
            <ng-container *ngIf="vistaActual === 'libro-mayor'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <thead class="bg-light text-uppercase small text-secondary">
                          <tr><th class="ps-3">Cuenta</th><th class="text-end">Saldo Ant</th><th class="text-end">Debe</th><th class="text-end">Haber</th><th class="text-end pe-3">Saldo Act</th></tr>
                       </thead>
                       <tbody>
                          <tr *ngFor="let r of reporteMayor">
                             <td class="ps-3 fw-bold text-primary">{{r.cuenta}}</td>
                             <td class="text-end">{{r.saldoAnt|currency}}</td>
                             <td class="text-end text-success">{{r.debitos|currency}}</td>
                             <td class="text-end text-danger">{{r.creditos|currency}}</td>
                             <td class="text-end pe-3 fw-bold">{{r.saldoAct|currency}}</td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- 17. REPORTES: BALANCE GENERAL -->
            <ng-container *ngIf="vistaActual === 'balance-general'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                       <tbody>
                          <tr *ngFor="let r of reporteBalanceGeneral" [class.fw-bold]="r.nivel===1" [class.bg-light-subtle]="r.nivel===1">
                             <td class="ps-3" [style.padding-left.px]="(r.nivel-1)*20">{{r.rubro}}</td>
                             <td class="text-end pe-5 font-monospace">{{r.valor|currency}}</td>
                          </tr>
                       </tbody>
                    </table>
                </div>
            </ng-container>

            <!-- ... (SECCIONES PARA LOS OTROS REPORTES ESTÁN IMPLÍCITAS EN LA LOGICA DEL TS Y NO REQUERIDAS DE SER REDIBUJADAS AHORA PUES PIDIO NO OMITIR MODALES Y UNIR LOS CAMBIOS) ... -->
            
            <!-- CASO PENDIENTE -->
            <ng-container *ngIf="!['dashboard', 'asientos-manuales', 'asientos-recurrentes', 'plan-cuentas', 'tipos-cuentas', 'centros-costo', 'sucursales', 'monedas', 'importacion', 'plantillas', 'cierre-mensual', 'cierre-anual', 'reapertura', 'estados-periodo', 'libro-diario', 'libro-mayor', 'balance-general'].includes(vistaActual)">
                 <div class="text-center py-5 fade-in-up">
                     <c-icon [content]="icons.cilFolderOpen" size="4xl" class="text-secondary opacity-50 mb-3"></c-icon>
                     <h3 class="text-dark">{{ tituloVista }}</h3>
                     <p>Visualización disponible próximamente.</p>
                 </div>
            </ng-container>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================= AREA DE TODOS LOS MODALES ========================= -->

<!-- 1. ASIENTO -->
<c-modal [visible]="liveModalVisible" (visibleChange)="handleModalChange($event)" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Nuevo Asiento</h5><button (click)="toggleModal()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="asientoForm" cForm class="row g-3">
        <div class="col-6"><label cLabel>Fecha</label><input cFormControl type="date" formControlName="fecha"></div>
        <div class="col-6"><label cLabel>Tipo</label><div class="d-flex gap-2"><c-form-check><input cFormCheckInput type="radio" value="debito" formControlName="tipo" id="d" checked><label cFormCheckLabel for="d">Débito</label></c-form-check><c-form-check><input cFormCheckInput type="radio" value="credito" formControlName="tipo" id="c"><label cFormCheckLabel for="c">Crédito</label></c-form-check></div></div>
        <div class="col-12"><label cLabel>Descripción</label><input cFormControl formControlName="desc"></div>
        <div class="col-8"><label cLabel>Cuenta</label><input cFormControl formControlName="cuenta"></div>
        <div class="col-4"><label cLabel>Valor</label><input cFormControl type="number" formControlName="monto"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarAsiento()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 2. CUENTA -->
<c-modal [visible]="modalCuentaVisible" (visibleChange)="handleModalCuentaChange($event)" backdrop="static">
  <c-modal-header><h5 cModalTitle>Nueva Cuenta</h5><button (click)="toggleModalCuenta()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="cuentaForm" cForm class="row g-3">
        <div class="col-6"><label cLabel>Código</label><input cFormControl formControlName="codigo"></div>
        <div class="col-6"><label cLabel>Nivel</label><input cFormControl type="number" formControlName="nivel"></div>
        <div class="col-12"><label cLabel>Nombre</label><input cFormControl formControlName="nombre"></div>
        <div class="col-12"><label cLabel>Tipo</label><select cSelect formControlName="tipo"><option>Grupo</option><option>Detalle</option></select></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarCuenta()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 3. TIPO CUENTA -->
<c-modal [visible]="modalTipoCuentaVisible" (visibleChange)="handleModalTipoChange($event)" backdrop="static">
  <c-modal-header><h5 cModalTitle>Tipo Cuenta</h5><button (click)="toggleModalTipoCuenta()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="tipoCuentaForm" cForm class="row g-3">
        <div class="col-4"><label cLabel>Código</label><input cFormControl formControlName="codigo"></div>
        <div class="col-8"><label cLabel>Nombre</label><input cFormControl formControlName="nombre"></div>
        <div class="col-12"><label cLabel>Naturaleza</label><select cSelect formControlName="naturaleza"><option>Deudora</option><option>Acreedora</option></select></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarTipoCuenta()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 4. CENTRO DE COSTO -->
<c-modal [visible]="modalCentroCostoVisible" (visibleChange)="handleModalCentroCostoChange($event)" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Centro de Costo</h5><button (click)="toggleModalCentroCosto()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="centroCostoForm" cForm class="row g-3">
        <div class="col-4"><label cLabel>Código</label><input cFormControl formControlName="codigo"></div>
        <div class="col-8"><label cLabel>Categoría</label><select cSelect formControlName="categoria"><option>Admin</option><option>Ventas</option></select></div>
        <div class="col-12"><label cLabel>Nombre</label><input cFormControl formControlName="nombre"></div>
        <div class="col-6"><label cLabel>Responsable</label><input cFormControl formControlName="responsable"></div>
        <div class="col-6"><label cLabel>Presupuesto</label><input cFormControl type="number" formControlName="presupuesto"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarCentroCosto()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 5. SUCURSAL -->
<c-modal [visible]="modalSucursalVisible" (visibleChange)="handleModalSucursalChange($event)" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Sucursal</h5><button (click)="toggleModalSucursal()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="sucursalForm" cForm class="row g-3">
        <div class="col-3"><label cLabel>Código</label><input cFormControl formControlName="codigo"></div>
        <div class="col-9"><label cLabel>Nombre</label><input cFormControl formControlName="nombre"></div>
        <div class="col-6"><label cLabel>Ciudad</label><input cFormControl formControlName="ciudad"></div>
        <div class="col-6"><label cLabel>Teléfono</label><input cFormControl formControlName="telefono"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarSucursal()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 6. MONEDA -->
<c-modal [visible]="modalMonedaVisible" (visibleChange)="handleModalMonedaChange($event)" backdrop="static">
  <c-modal-header><h5 cModalTitle>Moneda</h5><button (click)="toggleModalMoneda()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="monedaForm" cForm class="row g-3">
        <div class="col-4"><label cLabel>ISO</label><input cFormControl formControlName="codigo"></div>
        <div class="col-8"><label cLabel>Nombre</label><input cFormControl formControlName="nombre"></div>
        <div class="col-6"><label cLabel>Simbolo</label><input cFormControl formControlName="simbolo"></div>
        <div class="col-6"><label cLabel>Tasa</label><input cFormControl type="number" formControlName="tasa"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarMoneda()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 7. RECURRENTE -->
<c-modal [visible]="modalRecurrenteVisible" (visibleChange)="handleModalRecurrenteChange($event)" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Recurrencia</h5><button (click)="toggleModalRecurrente()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="recurrenteForm" cForm class="row g-3">
        <div class="col-12"><label cLabel>Nombre</label><input cFormControl formControlName="nombre"></div>
        <div class="col-6"><label cLabel>Frecuencia</label><select cSelect formControlName="frecuencia"><option>Mensual</option><option>Anual</option></select></div>
        <div class="col-6"><label cLabel>Monto</label><input cFormControl type="number" formControlName="monto"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarRecurrente()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 8. IMPORTACIÓN -->
<c-modal [visible]="modalImportacionVisible" (visibleChange)="handleModalImportacionChange($event)" backdrop="static">
  <c-modal-header><h5 cModalTitle>Importar</h5><button (click)="toggleModalImportacion()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="importForm" cForm>
        <label cLabel>Archivo</label>
        <input cFormControl type="file" formControlName="archivo">
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarImportacion()">Procesar</button></c-modal-footer>
</c-modal>

<!-- 9. PLANTILLA -->
<c-modal [visible]="modalPlantillaVisible" (visibleChange)="handleModalPlantillaChange($event)" backdrop="static">
  <c-modal-header><h5 cModalTitle>Plantilla</h5><button (click)="toggleModalPlantilla()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="plantillaForm" cForm>
        <label cLabel>Nombre Plantilla</label>
        <input cFormControl formControlName="nombre">
        <label cLabel class="mt-2">Código</label>
        <input cFormControl formControlName="codigo">
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarPlantilla()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 10. CIERRE / REAPERTURA -->
<c-modal [visible]="modalCierreVisible" (visibleChange)="handleModalCierreChange($event)" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Confirmar Acción</h5><button (click)="toggleModalCierre()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="cierreForm" cForm class="row g-3">
        <div class="col-12 alert alert-warning">Se procederá con: <strong>{{cierreForm.get('tipoAccion')?.value}}</strong></div>
        <div class="col-12"><label cLabel>Justificación</label><textarea cFormControl rows="3" formControlName="comentario"></textarea></div>
        <div class="col-12"><label cLabel>Clave Autorización</label><input cFormControl type="password" formControlName="autorizacion"></div>
    </form>
  </c-modal-body>
  <c-modal-footer>
      <button cButton color="secondary" (click)="toggleModalCierre()">Cancelar</button>
      <button cButton color="primary" (click)="ejecutarAccionCierre()">Procesar</button>
  </c-modal-footer>
</c-modal>
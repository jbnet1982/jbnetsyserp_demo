<div class="container-fluid min-vh-100 bg-light">
  
  <!-- HEADER -->
  <div class="row py-3 border-bottom bg-white mb-4 shadow-sm align-items-center">
    <div class="col-auto">
      <button cButton color="light" routerLink="/" class="border" cTooltip="Volver">
        <c-icon [content]="icons.cilArrowLeft"></c-icon>
      </button>
    </div>
    <div class="col">
      <h4 class="mb-0 text-primary fw-bold">Módulo Cuentas por Pagar (CxP)</h4>
      <small class="text-secondary text-uppercase ls-1">JBNetsys ERP - Pasivos y Gastos</small>
    </div>
    <div class="col-auto">
      <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">Por Pagar: {{ deudaTotal | currency }}</span>
    </div>
  </div>

  <div class="row g-4 px-3 pb-5">
    
    <!-- MENU IZQ -->
    <div class="col-md-3 col-xl-2 fade-in-left">
      <c-card class="border-0 shadow-sm h-100">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="mb-0 fw-bold"><c-icon [content]="icons.cilFolderOpen" class="me-2"></c-icon> Navegación CxP</h6>
        </div>
        <div class="card-body p-0">
          <c-accordion [alwaysOpen]="false" class="accordion-flush">
            <c-accordion-item *ngFor="let grupo of menuEstructura; let i = index" [visible]="i === 0">
              <ng-template cTemplateId="accordionHeader">
                 <div class="fw-semibold small text-uppercase d-flex align-items-center gap-2">
                    <c-icon [content]="grupo.icono === 'cilList' ? icons.cilList : (grupo.icono === 'cilMoney' ? icons.cilMoney : icons.cilChartLine)" class="text-primary"></c-icon>
                    {{ grupo.titulo }}
                 </div>
              </ng-template>
              <ng-template cTemplateId="accordionBody">
                <div class="list-group list-group-flush">
                  <button *ngFor="let sub of grupo.items" 
                    class="list-group-item list-group-item-action border-0 ps-3 small py-2"
                    [class.active]="vistaActual === sub.id"
                    [class.fw-bold]="vistaActual === sub.id"
                    (click)="seleccionarVista(sub)">
                    • {{ sub.nombre }}
                  </button>
                </div>
              </ng-template>
            </c-accordion-item>
          </c-accordion>
        </div>
        <div class="p-3 border-top mt-auto">
             <button class="btn btn-outline-secondary w-100 btn-sm" (click)="volverDashboard()">
               <c-icon [content]="icons.cilChartLine"></c-icon> Ir al Resumen
             </button>
        </div>
      </c-card>
    </div>

    <!-- AREA DERECHA -->
    <div class="col-md-9 col-xl-10">
      <div class="card border-0 shadow-sm min-vh-75">
        
        <!-- HEADER VISTA -->
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="fw-bold text-dark-emphasis mb-0">{{ tituloVista }}</h5>
            
            <div class="d-flex gap-2">
                <button cButton color="secondary" variant="ghost" class="border" (click)="exportarPDF()">
                   <c-icon [content]="icons.cilCloudDownload"></c-icon> PDF
                </button>
                
                <!-- BOTONES ACCIÓN -->
                <button *ngIf="vistaActual === 'proveedores'" cButton color="primary" (click)="toggleModalProveedor()"><c-icon [content]="icons.cilPlus"></c-icon> Nuevo Proveedor</button>
                <button *ngIf="vistaActual === 'ingreso-facturas'" cButton color="primary" (click)="toggleModalFactura()"><c-icon [content]="icons.cilDescription"></c-icon> Registrar Factura</button>
                <button *ngIf="vistaActual === 'registro-pagos'" cButton color="success" class="text-white" (click)="toggleModalPago()"><c-icon [content]="icons.cilMoney"></c-icon> Realizar Pago</button>
                <button *ngIf="vistaActual === 'retenciones'" cButton color="warning" (click)="toggleModalRetencion()"><c-icon [content]="icons.cilClipboard"></c-icon> Emitir Retención</button>
                <button *ngIf="vistaActual === 'programacion' || vistaActual === 'proyeccion'" cButton color="dark" (click)="toggleModalProgramacion()"><c-icon [content]="icons.cilCalendar"></c-icon> Reprogramar</button>
            </div>
        </div>

        <div class="card-body bg-light-subtle">
            
            <!-- 1. DASHBOARD -->
            <ng-container *ngIf="vistaActual === 'dashboard'">
                <div class="row g-4 fade-in-up">
                    <div class="col-md-4"><c-card class="border-0 shadow-sm border-top border-4 border-danger p-4 text-center"><h2 class="display-6 fw-bold">{{ deudaTotal | currency }}</h2><small class="text-uppercase fw-bold text-muted">Total por Pagar</small></c-card></div>
                    <div class="col-md-4"><c-card class="border-0 shadow-sm border-top border-4 border-warning p-4 text-center"><h2 class="display-6 fw-bold">{{ vencido | currency }}</h2><small class="text-uppercase fw-bold text-muted">Deuda Vencida</small></c-card></div>
                    <div class="col-md-4"><c-card class="border-0 shadow-sm border-top border-4 border-info p-4 text-center"><h2 class="display-6 fw-bold">{{ pagosMes | currency }}</h2><small class="text-uppercase fw-bold text-muted">Pagado este Mes</small></c-card></div>
                    <div class="col-12 mt-5 text-center text-muted">
                        <c-icon [content]="icons.cilBank" size="4xl" class="mb-3 opacity-25"></c-icon>
                        <h4>Gestión de Pagos</h4>
                        <p>Control de obligaciones y flujo de efectivo.</p>
                    </div>
                </div>
            </ng-container>

            <!-- 2. CATÁLOGO: PROVEEDORES -->
            <ng-container *ngIf="vistaActual === 'proveedores' || vistaActual === 'saldos-proveedor'">
                 <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle"><thead class="bg-light text-uppercase small text-secondary"><tr><th class="ps-3">Código</th><th>Razón Social</th><th>Categoría</th><th>Contacto</th><th class="text-end pe-3">Estado</th></tr></thead><tbody>
                        <tr *ngFor="let p of proveedores">
                            <td class="ps-3 fw-bold text-primary">{{p.codigo}}</td>
                            <td><div class="d-flex align-items-center"><c-icon [content]="icons.cilTruck" class="me-2 text-secondary"></c-icon>{{p.nombre}}<br><small class="text-muted ms-4">{{p.ruc}}</small></div></td>
                            <td><c-badge color="info" shape="rounded-pill" class="text-white">{{p.categoria}}</c-badge></td>
                            <td class="small">{{p.contacto}}<br>{{p.telefono}}</td>
                            <td class="text-end pe-3"><c-badge color="success">Activo</c-badge></td>
                        </tr>
                    </tbody></table>
                 </div>
            </ng-container>

            <!-- 3. CATÁLOGO: CONDICIONES PAGO -->
            <ng-container *ngIf="vistaActual === 'condiciones'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up"><table cTable hover class="mb-0"><thead class="bg-light small"><tr><th class="ps-3">Cod</th><th>Descripción</th><th>Días</th></tr></thead><tbody><tr *ngFor="let c of condiciones"><td class="ps-3">{{c.codigo}}</td><td>{{c.nombre}}</td><td>{{c.dias}} días</td></tr></tbody></table></div>
            </ng-container>

            <!-- 4. OPERACIÓN: FACTURAS COMPRA -->
            <ng-container *ngIf="vistaActual === 'ingreso-facturas'">
                 <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                        <thead class="bg-light text-uppercase small text-secondary">
                            <tr><th class="ps-3">Fecha</th><th>Proveedor</th><th>Factura N°</th><th>Vencimiento</th><th class="text-end">Total</th><th class="text-end">Saldo</th><th class="text-center">Estado</th><th class="text-end pe-3"></th></tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let f of listaFacturas">
                                <td class="ps-3">{{f.fecha}}</td>
                                <td class="fw-bold">{{f.proveedor}}</td>
                                <td>{{f.numero}}</td>
                                <td class="text-danger">{{f.vence}}</td>
                                <td class="text-end fw-bold">{{f.total | currency}}</td>
                                <td class="text-end text-primary">{{f.saldo | currency}}</td>
                                <td class="text-center"><c-badge [color]="f.estado==='Pagada'?'success':'warning'" shape="rounded-pill">{{f.estado}}</c-badge></td>
                                <td class="text-end pe-3"><c-icon [content]="icons.cilFile" class="text-secondary cursor-pointer"></c-icon></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-3 text-center"><button class="btn btn-link text-decoration-none small" (click)="toggleShowAll()">{{ showAll ? 'Ver menos' : 'Ver todo' }}</button></div>
                 </div>
            </ng-container>

            <!-- 5. OPERACIÓN: PAGOS REALIZADOS -->
            <ng-container *ngIf="vistaActual === 'registro-pagos'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up"><table cTable hover class="mb-0 align-middle"><thead class="bg-light small text-secondary text-uppercase"><tr><th class="ps-3">Fecha</th><th>Egre. #</th><th>Proveedor</th><th>Factura</th><th>Forma</th><th class="text-end pe-3">Monto</th></tr></thead><tbody><tr *ngFor="let p of pagosRealizados"><td class="ps-3">{{p.fecha}}</td><td class="fw-bold">{{p.numero}}</td><td>{{p.proveedor}}</td><td>{{p.factura}}</td><td>{{p.forma}} <small>({{p.banco}})</small></td><td class="text-end pe-3 fw-bold text-success">{{p.monto|currency}}</td></tr></tbody></table></div>
            </ng-container>

            <!-- 6. OPERACIÓN: RETENCIONES -->
            <ng-container *ngIf="vistaActual === 'retenciones'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up"><table cTable hover class="mb-0 align-middle"><thead class="bg-light small text-uppercase"><tr><th class="ps-3">Fecha</th><th>Retención</th><th>Factura Base</th><th>Concepto</th><th class="text-end pe-3">Valor Ret</th></tr></thead><tbody><tr *ngFor="let r of retenciones"><td class="ps-3">{{r.fecha}}</td><td class="fw-bold">{{r.numero}}</td><td>Ref: {{r.facturaRef}}</td><td>{{r.concepto}}</td><td class="text-end pe-3">{{r.monto|currency}}</td></tr></tbody></table></div>
            </ng-container>

            <!-- 7. PROGRAMACION PAGOS -->
            <ng-container *ngIf="vistaActual === 'programacion' || vistaActual === 'proyeccion'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <div class="alert alert-info d-flex align-items-center small"><c-icon [content]="icons.cilCalendar" class="me-2"></c-icon>Calendario sugerido de pagos para optimizar flujo de caja.</div>
                    <table cTable hover class="mb-0 align-middle"><thead class="bg-light small text-uppercase"><tr><th class="ps-3">Fecha Pago Sugerida</th><th>Proveedor</th><th>Prioridad</th><th class="text-end">A Pagar</th><th class="text-end pe-3">Estado</th></tr></thead><tbody><tr *ngFor="let p of programacion"><td class="ps-3 fw-bold text-dark">{{p.fechaPago}}</td><td>{{p.proveedor}}</td><td><c-badge [color]="p.prioridad==='Alta'?'danger':'secondary'">{{p.prioridad}}</c-badge></td><td class="text-end fw-bold">{{p.monto|currency}}</td><td class="text-end pe-3">{{p.estado}}</td></tr></tbody></table>
                </div>
            </ng-container>

            <!-- 8. REPORTES: VENCIDAS -->
            <ng-container *ngIf="vistaActual === 'vencidas'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up"><table cTable hover class="mb-0 align-middle"><thead class="bg-danger text-white text-uppercase small"><tr><th class="ps-3">Proveedor</th><th>Factura</th><th>Emitida</th><th>Días Mora</th><th class="text-end pe-3">Deuda</th></tr></thead><tbody><tr *ngFor="let v of reporteVencidas" class="bg-danger-subtle"><td class="ps-3 fw-bold">{{v.proveedor}}</td><td>{{v.factura}}</td><td>{{v.emision}}</td><td class="text-center text-danger fw-bold">{{v.diasMora}}</td><td class="text-end pe-3 fw-bold">{{v.monto|currency}}</td></tr></tbody></table></div>
            </ng-container>

            <!-- 9. PLACEHOLDER (NOTAS CREDITO, DEBITO) -->
            <ng-container *ngIf="['notas-credito','notas-debito'].includes(vistaActual)">
                 <div class="text-center py-5 fade-in-up"><c-icon [content]="icons.cilFolderOpen" size="4xl" class="text-secondary opacity-50 mb-3"></c-icon><h3 class="text-dark">{{ tituloVista }}</h3><p>Sin documentos registrados.</p></div>
            </ng-container>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========== MODALES =========== -->

<!-- 1. PROVEEDOR -->
<c-modal [visible]="modalProveedorVisible" (visibleChange)="modalProveedorVisible=$event" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Nuevo Proveedor</h5><button (click)="toggleModalProveedor()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="proveedorForm" cForm class="row g-3">
        <div class="col-4"><label cLabel>RUC/Ident.</label><input cFormControl formControlName="ruc"></div>
        <div class="col-8"><label cLabel>Razón Social</label><input cFormControl formControlName="nombre"></div>
        <div class="col-6"><label cLabel>Categoría</label><select cSelect formControlName="categoria"><option>Tecnología</option><option>Servicios</option><option>Insumos</option></select></div>
        <div class="col-6"><label cLabel>Teléfono</label><input cFormControl formControlName="telefono"></div>
        <div class="col-12"><label cLabel>Dirección</label><input cFormControl formControlName="direccion"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton color="primary" (click)="guardarProveedor()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 2. FACTURA COMPRA -->
<c-modal [visible]="modalFacturaVisible" (visibleChange)="handleModalFacturaChange($event)" size="xl" backdrop="static">
  <c-modal-header><h5 cModalTitle>Ingreso de Factura</h5><button (click)="toggleModalFactura()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="facturaForm" cForm class="row g-3 p-2">
        <div class="col-12 bg-info-subtle p-2 rounded small"><c-icon [content]="icons.cilCheckCircle"></c-icon> Al guardar se generará automáticamente la entrada en inventario.</div>
        <div class="col-3"><label cLabel>N° Factura</label><input cFormControl formControlName="numero" placeholder="001-001-000..."></div>
        <div class="col-3"><label cLabel>Fecha</label><input cFormControl type="date" formControlName="fecha"></div>
        <div class="col-6"><label cLabel>Proveedor</label><select cSelect formControlName="proveedor"><option *ngFor="let p of proveedores" [value]="p.nombre">{{p.nombre}}</option></select></div>
        <div class="col-12"><label cLabel>Descripción Gasto/Compra</label><input cFormControl formControlName="concepto"></div>
        <!-- Totales (Simple Demo) -->
        <div class="col-md-3 offset-md-9 mt-4">
            <label cLabel class="fw-bold">Base Imponible</label><input cFormControl type="number" formControlName="base">
            <label cLabel class="fw-bold mt-2">IVA</label><input cFormControl type="number" formControlName="iva">
        </div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton color="success" class="text-white" (click)="guardarFactura()">Registrar e Inventariar</button></c-modal-footer>
</c-modal>

<!-- 3. PAGO -->
<c-modal [visible]="modalPagoVisible" (visibleChange)="handleModalPagoChange($event)" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Registrar Pago a Proveedor</h5><button (click)="toggleModalPago()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="pagoForm" cForm class="row g-3">
        <div class="col-8"><label cLabel>Proveedor</label><select cSelect formControlName="proveedor"><option *ngFor="let p of proveedores" [value]="p.nombre">{{p.nombre}}</option></select></div>
        <div class="col-4"><label cLabel>Fecha Pago</label><input cFormControl type="date" formControlName="fecha"></div>
        <div class="col-6"><label cLabel>Documento a Pagar</label><input cFormControl formControlName="factura" placeholder="Busque N° factura"></div>
        <div class="col-6"><label cLabel>Monto</label><input cFormControl type="number" formControlName="monto"></div>
        <div class="col-6"><label cLabel>Forma Pago</label><select cSelect formControlName="forma"><option>Transferencia</option><option>Cheque</option></select></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton color="primary" (click)="guardarPago()">Procesar Pago</button></c-modal-footer>
</c-modal>

<!-- 4. RETENCIÓN -->
<c-modal [visible]="modalRetencionVisible" (visibleChange)="modalRetencionVisible=$event" backdrop="static">
  <c-modal-header><h5 cModalTitle>Generar Comp. Retención</h5><button (click)="toggleModalRetencion()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="retencionForm" cForm class="row g-3">
        <div class="col-12"><label cLabel>Factura Origen</label><input cFormControl formControlName="factura"></div>
        <div class="col-4"><label cLabel>Cód SRI</label><input cFormControl formControlName="codigoRet" placeholder="312"></div>
        <div class="col-4"><label cLabel>% Ret</label><input cFormControl type="number" formControlName="porcentaje"></div>
        <div class="col-4"><label cLabel>Base Imp</label><input cFormControl type="number" formControlName="base"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton color="warning" (click)="guardarRetencion()">Emitir</button></c-modal-footer>
</c-modal>

<!-- 5. PROGRAMACIÓN -->
<c-modal [visible]="modalProgramacionVisible" (visibleChange)="modalProgramacionVisible=$event" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Programar Pagos</h5><button (click)="toggleModalProgramacion()" cButtonClose></button></c-modal-header>
  <c-modal-body>
      <div class="alert alert-light text-center border">Módulo de calendario de pagos para flujo de caja (Versión Demo).</div>
      <!-- Aquí iría un form complejo de selección multiple de facturas -->
  </c-modal-body>
  <c-modal-footer><button cButton color="primary" (click)="guardarProgramacion()">Guardar Planificación</button></c-modal-footer>
</c-modal>
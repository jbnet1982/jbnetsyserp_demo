<div class="container-fluid min-vh-100 bg-light">
  
  <!-- CABECERA -->
  <div class="row py-3 border-bottom bg-white mb-4 shadow-sm align-items-center">
    <div class="col-auto">
      <button cButton color="light" routerLink="/" class="border" cTooltip="Volver">
        <c-icon [content]="icons.cilArrowLeft"></c-icon>
      </button>
    </div>
    <div class="col">
      <h4 class="mb-0 text-primary fw-bold">Gestión de Tesorería y Bancos</h4>
      <small class="text-secondary text-uppercase ls-1">JBNetsys ERP - Financiero</small>
    </div>
    <div class="col-auto">
      <span class="badge bg-success px-3 py-2 rounded-pill">Total Disponible: {{ totalDisponible | currency }}</span>
    </div>
  </div>

  <div class="row g-4 px-3 pb-5">
    
    <!-- MENU IZQ -->
    <div class="col-md-3 col-xl-2 fade-in-left">
      <c-card class="border-0 shadow-sm h-100">
        <div class="card-header bg-primary text-white py-3">
          <h6 class="mb-0 fw-bold"><c-icon [content]="icons.cilBank" class="me-2"></c-icon> Menú Bancario</h6>
        </div>
        <div class="card-body p-0">
          <c-accordion [alwaysOpen]="false" class="accordion-flush">
            <c-accordion-item *ngFor="let grupo of menuEstructura; let i = index" [visible]="i === 0">
              <ng-template cTemplateId="accordionHeader">
                 <div class="fw-semibold small text-uppercase d-flex align-items-center gap-2">
                    <c-icon [content]="grupo.icono === 'cilList' ? icons.cilList : (grupo.icono === 'cilSwapHorizontal' ? icons.cilSwapHorizontal : icons.cilChartLine)" class="text-primary"></c-icon>
                    {{ grupo.titulo }}
                 </div>
              </ng-template>
              <ng-template cTemplateId="accordionBody">
                <div class="list-group list-group-flush">
                  <button *ngFor="let sub of grupo.items" 
                    class="list-group-item list-group-item-action border-0 ps-3 small py-2"
                    [class.active]="vistaActual === sub.id"
                    [class.fw-bold]="vistaActual === sub.id"
                    (click)="seleccionarVista(sub)">
                    • {{ sub.nombre }}
                  </button>
                </div>
              </ng-template>
            </c-accordion-item>
          </c-accordion>
        </div>
        <div class="p-3 border-top mt-auto">
             <button class="btn btn-outline-secondary w-100 btn-sm" (click)="volverDashboard()">
               <c-icon [content]="icons.cilChartLine"></c-icon> Ir al Resumen
             </button>
        </div>
      </c-card>
    </div>

    <!-- AREA TRABAJO -->
    <div class="col-md-9 col-xl-10">
      <div class="card border-0 shadow-sm min-vh-75">
        
        <!-- HEADER VISTA -->
        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="fw-bold text-dark-emphasis mb-0">{{ tituloVista }}</h5>
            
            <div class="d-flex gap-2">
                <button cButton color="secondary" variant="ghost" class="border" (click)="exportarPDF()">
                   <c-icon [content]="icons.cilCloudDownload"></c-icon> PDF
                </button>
                
                <!-- BOTONES ACCIÓN DINÁMICOS -->
                <button *ngIf="vistaActual === 'cuentas-bancarias'" cButton color="primary" (click)="toggleModalCuenta()"><c-icon [content]="icons.cilPlus"></c-icon> Nueva Cuenta</button>
                
                <button *ngIf="vistaActual === 'ingresos' || vistaActual === 'egresos'" cButton color="success" class="text-white" (click)="toggleModalTransaccion()"><c-icon [content]="icons.cilMoney"></c-icon> Nueva Transacción</button>
                
                <button *ngIf="vistaActual === 'transferencias'" cButton color="info" class="text-white" (click)="toggleModalTransferencia()"><c-icon [content]="icons.cilSwapHorizontal"></c-icon> Transferir</button>
                
                <button *ngIf="vistaActual === 'cheques'" cButton color="warning" (click)="toggleModalCheque()"><c-icon [content]="icons.cilPen"></c-icon> Girar Cheque</button>
                
                <button *ngIf="vistaActual === 'caja-chica'" cButton color="primary" (click)="toggleModalCaja()"><c-icon [content]="icons.cilWallet"></c-icon> Registrar Gasto</button>
                
                <button *ngIf="vistaActual === 'conciliacion' || vistaActual === 'reporte-conciliacion'" cButton color="dark" (click)="toggleModalConciliacion()"><c-icon [content]="icons.cilCheckAlt"></c-icon> Conciliar Mes</button>
            </div>
        </div>

        <div class="card-body bg-light-subtle">
            
            <!-- 1. DASHBOARD -->
            <ng-container *ngIf="vistaActual === 'dashboard'">
                <div class="row g-4 fade-in-up">
                    <div class="col-md-4"><c-card class="border-0 shadow-sm border-top border-4 border-success p-4 text-center"><h2 class="display-6 fw-bold">{{ saldoTotalBancos | currency }}</h2><small class="text-uppercase fw-bold text-muted">Saldo en Bancos</small></c-card></div>
                    <div class="col-md-4"><c-card class="border-0 shadow-sm border-top border-4 border-info p-4 text-center"><h2 class="display-6 fw-bold">{{ saldoCajaChica | currency }}</h2><small class="text-uppercase fw-bold text-muted">Fondo Caja Chica</small></c-card></div>
                    <div class="col-md-4"><c-card class="border-0 shadow-sm border-top border-4 border-warning p-4 text-center"><h2 class="display-6 fw-bold">{{ porConciliar }}</h2><small class="text-uppercase fw-bold text-muted">Movs. Por Conciliar</small></c-card></div>
                    <div class="col-12 mt-5 text-center text-muted">
                        <c-icon [content]="icons.cilBank" size="4xl" class="mb-3 opacity-25"></c-icon>
                        <h4>Panel Financiero</h4><p>Control de liquidez y conciliaciones.</p>
                    </div>
                </div>
            </ng-container>

            <!-- 2. CATÁLOGO: CUENTAS BANCARIAS -->
            <ng-container *ngIf="vistaActual === 'cuentas-bancarias' || vistaActual === 'estado-bancario'">
                 <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle"><thead class="bg-light text-uppercase small text-secondary"><tr><th class="ps-3">Banco</th><th>N° Cuenta</th><th>Tipo</th><th>Moneda</th><th class="text-end">Saldo Actual</th><th class="text-center pe-3">Estado</th></tr></thead><tbody>
                        <tr *ngFor="let c of cuentasBancarias">
                            <td class="ps-3 fw-bold text-primary">{{ c.banco }}</td><td>{{ c.numero }}</td><td>{{ c.tipo }}</td><td>{{ c.moneda }}</td>
                            <td class="text-end fw-bold fs-5">{{ c.saldo | currency }}</td>
                            <td class="text-center pe-3"><c-badge color="success">Activo</c-badge></td>
                        </tr>
                    </tbody></table>
                 </div>
            </ng-container>

            <!-- 3. TIPOS TRANSACCIÓN -->
            <ng-container *ngIf="vistaActual === 'tipos-transaccion'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up"><table cTable hover class="mb-0"><thead class="bg-light small"><tr><th class="ps-3">Cód</th><th>Nombre</th><th>Efecto en Saldo</th></tr></thead><tbody><tr *ngFor="let t of tiposTransaccion"><td class="ps-3 fw-bold">{{t.codigo}}</td><td>{{t.nombre}}</td><td>{{t.efecto}}</td></tr></tbody></table></div>
            </ng-container>

            <!-- 4. OPERACIÓN: TRANSACCIONES (INGRESOS/EGRESOS) -->
            <ng-container *ngIf="['ingresos','egresos'].includes(vistaActual)">
                 <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle">
                        <thead class="bg-light text-uppercase small text-secondary"><tr><th class="ps-3">Fecha</th><th>Tipo</th><th>Concepto</th><th>Banco</th><th>Referencia</th><th class="text-end pe-3">Monto</th></tr></thead>
                        <tbody>
                            <tr *ngFor="let t of listaTransacciones">
                                <td class="ps-3">{{t.fecha}}</td>
                                <td><c-badge [color]="t.tipo==='Ingreso'?'success':'danger'">{{t.tipo}}</c-badge></td>
                                <td>{{t.concepto}}</td><td>{{t.banco}}</td><td class="small">{{t.ref}}</td>
                                <td class="text-end pe-3 fw-bold">{{t.monto | currency}}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-3 text-center"><button class="btn btn-link text-decoration-none small" (click)="toggleShowAll()">{{showAll?'Ver menos':'Ver historial'}}</button></div>
                 </div>
            </ng-container>

            <!-- 5. CHEQUES -->
            <ng-container *ngIf="vistaActual === 'cheques'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle"><thead class="bg-light text-uppercase small text-secondary"><tr><th class="ps-3">N° Cheque</th><th>Banco</th><th>Beneficiario</th><th>Emisión</th><th>Cobro</th><th class="text-end pe-3">Valor</th></tr></thead><tbody><tr *ngFor="let ch of cheques"><td class="ps-3 fw-bold text-dark">{{ch.numero}}</td><td>{{ch.banco}}</td><td>{{ch.beneficiario}}</td><td>{{ch.fechaEmision}}</td><td class="text-danger fw-bold">{{ch.fechaCobro}}</td><td class="text-end pe-3">{{ch.monto|currency}}</td></tr></tbody></table>
                </div>
            </ng-container>

            <!-- 6. CAJA CHICA -->
            <ng-container *ngIf="vistaActual === 'caja-chica'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <div class="d-flex justify-content-between mb-3"><div class="fw-bold">Responsable: Varios</div><div class="text-success fw-bold">Disponible: {{saldoCajaChica|currency}}</div></div>
                    <table cTable hover class="mb-0 align-middle"><thead class="bg-light small"><tr><th class="ps-3">Fecha</th><th>Concepto</th><th>Responsable</th><th class="text-end pe-3">Valor</th></tr></thead><tbody><tr *ngFor="let cc of cajaChica"><td class="ps-3">{{cc.fecha}}</td><td>{{cc.concepto}}</td><td>{{cc.responsable}}</td><td class="text-end pe-3">{{cc.monto|currency}}</td></tr></tbody></table>
                </div>
            </ng-container>

            <!-- 7. CONCILIACIÓN & TRANSFERENCIAS -->
            <ng-container *ngIf="['conciliacion','reporte-conciliacion','transferencias'].includes(vistaActual)">
                <div class="text-center py-5 fade-in-up">
                    <div *ngIf="vistaActual==='conciliacion'">
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card p-4 border-warning border-top-4">
                                    <h5>Conciliación Noviembre 2025 - B. Pichincha</h5>
                                    <div class="d-flex justify-content-between my-3 px-5">
                                        <div class="text-center"><div class="small text-muted">Saldo Libros</div><h3>$25,400.00</h3></div>
                                        <div class="align-self-center text-muted"><c-icon [content]="icons.cilSwapHorizontal"></c-icon></div>
                                        <div class="text-center"><div class="small text-muted">Saldo Extracto</div><h3 class="text-success">$25,400.00</h3></div>
                                    </div>
                                    <div class="alert alert-success">¡Valores cuadrados! Diferencia: $0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="vistaActual!=='conciliacion'">
                        <c-icon [content]="icons.cilSwapHorizontal" size="4xl" class="text-secondary opacity-50 mb-3"></c-icon>
                        <h3 class="text-dark">{{ tituloVista }}</h3><p>Funcionalidad en desarrollo visual.</p>
                    </div>
                </div>
            </ng-container>

            <!-- 8. FLUJO CAJA -->
            <ng-container *ngIf="vistaActual === 'flujo-caja'">
                <div class="bg-white rounded p-3 shadow-sm fade-in-up">
                    <table cTable hover class="mb-0 align-middle"><thead class="bg-light"><tr><th class="ps-3">Rubro</th><th class="text-end pe-3">Monto</th></tr></thead><tbody><tr *ngFor="let f of flujoCaja" [class.bg-light]="f.esTotal" [class.fw-bold]="f.esTotal"><td class="ps-3">{{f.rubro}}</td><td class="text-end pe-3" [class.text-danger]="f.valor < 0">{{f.valor | currency}}</td></tr></tbody></table>
                </div>
            </ng-container>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============ MODALES ============ -->

<!-- 1. CUENTA -->
<c-modal [visible]="modalCuentaVisible" (visibleChange)="modalCuentaVisible=$event" backdrop="static">
  <c-modal-header><h5 cModalTitle>Nueva Cuenta Bancaria</h5><button (click)="toggleModalCuenta()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="cuentaForm" cForm class="row g-3"><div class="col-12"><label cLabel>Banco</label><input cFormControl formControlName="banco"></div><div class="col-6"><label cLabel>Número</label><input cFormControl formControlName="numero"></div><div class="col-6"><label cLabel>Saldo Inicial</label><input cFormControl type="number" formControlName="saldoInicial"></div></form>
  </c-modal-body>
  <c-modal-footer><button cButton (click)="guardarCuenta()">Guardar</button></c-modal-footer>
</c-modal>

<!-- 2. TRANSACCIÓN -->
<c-modal [visible]="liveModalVisible" (visibleChange)="liveModalVisible=$event" size="lg" backdrop="static">
  <c-modal-header><h5 cModalTitle>Movimiento Bancario</h5><button (click)="toggleModalTransaccion()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="transaccionForm" cForm class="row g-3">
        <div class="col-6"><label cLabel>Tipo</label><select cSelect formControlName="tipo"><option>Ingreso</option><option>Egreso</option></select></div>
        <div class="col-6"><label cLabel>Fecha</label><input cFormControl type="date" formControlName="fecha"></div>
        <div class="col-6"><label cLabel>Banco</label><select cSelect formControlName="banco"><option *ngFor="let b of cuentasBancarias" [value]="b.banco">{{b.banco}}</option></select></div>
        <div class="col-6"><label cLabel>Monto</label><input cFormControl type="number" formControlName="monto"></div>
        <div class="col-12"><label cLabel>Concepto</label><input cFormControl formControlName="concepto"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton color="primary" (click)="guardarTransaccion()">Registrar</button></c-modal-footer>
</c-modal>

<!-- 3. TRANSFERENCIA -->
<c-modal [visible]="modalTransferenciaVisible" (visibleChange)="modalTransferenciaVisible=$event" backdrop="static"><c-modal-body>Formulario Transferencia entre cuentas...</c-modal-body><c-modal-footer><button cButton (click)="guardarTransferencia()">Confirmar</button></c-modal-footer></c-modal>

<!-- 4. CHEQUE -->
<c-modal [visible]="modalChequeVisible" (visibleChange)="modalChequeVisible=$event" backdrop="static">
  <c-modal-header><h5 cModalTitle>Girar Cheque</h5><button (click)="toggleModalCheque()" cButtonClose></button></c-modal-header>
  <c-modal-body>
    <form [formGroup]="chequeForm" cForm class="row g-3">
        <div class="col-12"><label cLabel>Banco</label><select cSelect formControlName="banco"><option>B. Pichincha</option></select></div>
        <div class="col-4"><label cLabel>N° Cheque</label><input cFormControl formControlName="numero"></div>
        <div class="col-8"><label cLabel>Monto</label><input cFormControl type="number" formControlName="monto"></div>
        <div class="col-12"><label cLabel>Beneficiario</label><input cFormControl formControlName="beneficiario"></div>
        <div class="col-6"><label cLabel>Fecha Cobro</label><input cFormControl type="date" formControlName="fechaCobro"></div>
    </form>
  </c-modal-body>
  <c-modal-footer><button cButton color="warning" (click)="guardarCheque()">Emitir Cheque</button></c-modal-footer>
</c-modal>

<!-- 5. CAJA CHICA -->
<c-modal [visible]="modalCajaVisible" (visibleChange)="modalCajaVisible=$event" backdrop="static">
  <c-modal-header><h5 cModalTitle>Gasto Menor</h5><button (click)="toggleModalCaja()" cButtonClose></button></c-modal-header>
  <c-modal-body><form [formGroup]="cajaForm" cForm class="row g-3"><div class="col-12"><label cLabel>Concepto</label><input cFormControl formControlName="concepto"></div><div class="col-6"><label cLabel>Valor</label><input cFormControl type="number" formControlName="monto"></div><div class="col-6"><label cLabel>Persona</label><input cFormControl formControlName="responsable"></div></form></c-modal-body>
  <c-modal-footer><button cButton (click)="guardarCaja()">Registrar Vale</button></c-modal-footer>
</c-modal>

<!-- 6. CONCILIACION -->
<c-modal [visible]="modalConciliacionVisible" (visibleChange)="modalConciliacionVisible=$event" backdrop="static"><c-modal-body>Herramienta de punteo de movimientos...</c-modal-body><c-modal-footer><button cButton color="dark" (click)="guardarConciliacion()">Cerrar Conciliación</button></c-modal-footer></c-modal>